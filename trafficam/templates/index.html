<!DOCTYPE html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Traffic Cameras</title>
    <style type="text/css">
      .hidden {
        display: none;
      }
      .shown {
        display: block;
      }
      .showninline {
        display: inline;
      }
      img.cam {
        max-width: 100%;
      }
    </style>
  </head>
  <body id="trafficam">
    <script type="text/javascript">
      function selectcam(url, name) {
        var cam = document.querySelector('#cam');
        cam.setAttribute("onerror", "this.onerror = null; this.src = '{{ url_for('static', filename='oops.jpg') }}';");
        cam.setAttribute("alt", name);
        cam.setAttribute("src", url);
      }
      function setcamlist(data) {
        var sel = document.querySelector('#camlist');
        selectcam(data[0].imgurl, data[0].name);
        for (var counter in data) {
          item = data[counter];
          opt = document.createElement("option");
          opt.appendChild(document.createTextNode(item['name']));
          opt.setAttribute('value', item.imgurl);
          sel.appendChild(opt);
        }
        sel.className = 'showninline';
        sel.setAttribute('onchange', "selectcam(this.value, this.options[this.selectedIndex].innerHTML);");
      }

      function setylocation(data) {
        var y = document.querySelector('#ylocation');
        result = data.query.results.Result
        y.innerHTML = result.line1 + ', ' + result.line2;
      }

      function success(position) {
        var a = document.querySelector('#acquiring');
        var f = document.querySelector('#found');
        var l = document.querySelector('#location');
        var y = document.querySelector('#ylocation');
        a.className = 'hidden';
        f.className = 'shown';
        l.innerHTML = position.coords.latitude + ', ' + position.coords.longitude;  

        var url1 = '{{ url_for('findcamera') }}?lat=' + position.coords.latitude + '&lon=' + position.coords.longitude + '&jsonp=setcamlist';
        var script1 = document.createElement("script");
        script1.setAttribute("src", url1);
        script1.setAttribute("type", "text/javascript");
        document.body.appendChild(script1);

        var url2 = 'http://query.yahooapis.com/v1/public/yql?q=use%20%22http%3A%2F%2Fgithub.com%2Fyql%2Fyql-tables%2Fraw%2Fmaster%2Fgeo%2Fgeo.placefinder.xml%22%20as%20placefinder%3B%20select%20*%20from%20placefinder%20where%20q%3D%22' + position.coords.latitude + ', ' + position.coords.longitude + '%22&format=json&diagnostics=true&callback=setylocation'
        var script2 = document.createElement("script");        
        script2.setAttribute("src", url2);
        script2.setAttribute("type", "text/javascript");                
        document.body.appendChild(script2);
      }

      function error() {
        var a = document.querySelector('#acquiring');
        var e = document.querySelector('#found');
        a.className = 'hidden';
        e.className = 'shown';
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success, error);
      } else {
        error();
      }
    </script>
    <p id="acquiring" class="shown">
      Acquiring location...
    </p>
    <p id="notfound" class="hidden">
      Your browser does not support geolocation.
    </p>
    <div id="found" class="hidden">
      <p>
        Your location is <span id="location">unknown</span>. <span id="ylocation">Getting address...</span>
      </p>
      <p>
        <select id="camlist" class="hidden"></select>
      </p>
      <p>
        <img id="cam" width="352" height="288" alt="Traffic image" src="{{ url_for('static', filename='loading.jpg') }}"/>
      </p>
    </div>
  </body>
</html>